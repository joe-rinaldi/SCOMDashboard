<!DOCTYPE html>
<html>
<!--

ToDO

	x change aeminfo and codeinfo nodes to display ameinfo ver=1401 2015-12-21 11:15
	x label soa-109 and soa-109 as Prod envs somehow
	x put service on soa040, change client, change scom Dashboard node.js service to be contained by soa040, make nodejs server easy to change
	- make adding addtional nodes a js array change only. minmal code change
	- create dashborad for mysubaru
			Dev
			http://mysubaru.dev.subaru1.com:7779/
			http://mysubaru.dev.subaru1.com:7779/health/report.xml

			QA
			http://www.qa.mysubaru.com/login.html
			http://www.qa.mysubaru.com/health/report.xml


			Prod
			preprod.mysubaru.com
			http://preprod.mysubaru.com/health/report.xml

	- create dashboard for scom qa
	- create dashbaord for b2cstartall.sh

		-  figure out rules for apache health ? display appropriate color

		Currently using
		http://js.cytoscape.org/#demos

		Misc dev links
		http://jointjs.com/demos
		http://www.graphdracula.net/showcase/
		http://nlpviz.bpodgursky.com/home
		http://bl.ocks.org/rkirsling/5001347
		http://sigmajs.org/
		http://www.jasondavies.com/graph-music/

		Subarau Links
		http://origin-www.subaru.com/health/report.xml

		Health
		http://scom-110.prod.subaru.com/health/report.xml
		http://scom2-110.prod.subaru.com/health/report.xml
		http://scom-109.prod.subaru.com/health/report.xml
		http://scom2-109.prod.subaru.com/health/report.xml

		Apache status
		http://scom-110.prod.subaru.com/server-status

-->
<head>
<style>
body {
  font: 14px helvetica neue, helvetica, arial, sans-serif;
}

#cy {
  height: 90%;
  width: 90%;
  position: absolute;
  left: 0;
  top: 0;
}


</style>

<meta charset=utf-8 />
<title>SCOM Dashboard</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script src="http://cytoscape.github.io/cytoscape.js/api/cytoscape.js-latest/cytoscape.min.js"></script>
<script src="https://jquery-xml2json-plugin.googlecode.com/svn/trunk/jquery.xml2json.js"></script>

</head>
<body>
<div id="cy"></div>
<script>
$(function(){ // on dom ready

var cy = cytoscape({
  container: document.getElementById('cy'),
  style: [
    {
      selector: 'node',
      css: {
        'content': 'data(name)',
        'background-color': 'green',
        'shape': 'roundrectangle',
        'text-valign': 'center',
        'text-halign': 'center'
      }
    },
    {
      selector: '$node > node',
      css: {
        'padding-top': '10px',
        'padding-left': '10px',
        'padding-bottom': '10px',
        'padding-right': '10px',
        'text-valign': 'top',
        'text-halign': 'center'
      }
    },
    {
      selector: 'edge',
      css: {
        'target-arrow-shape': 'triangle'
      }
    },
    {
      selector: ':selected',
      css: {
        'border-width': 3,
        'border-color': '#333'
      }
    }
  ],

  elements: {
    nodes: [
      { data: { id: 'scomdashboard', name: 'SCOM Dashboard Node.js Service' }, position: { x: 500, y: 100 } },
      { data: { id: 'originhealth', name: 'origin' }, position: { x: 100, y: 100 } },

      { data: { id: 'soa-110', name: 'soa-110 (PROD)'} },
      { data: { id: 'soa-110-health', name: 'apache health',  parent: 'soa-110'}},

      { data: { id: 'soa-110-scom', name: 'scom',  parent: 'soa-110' } },
      { data: { id: 'soa-110-scom-health', name: 'health',  parent: 'soa-110-scom' } },
      { data: { id: 'soa-110-scom-services-health', name: 'services health',  parent: 'soa-110-scom' } },
      { data: { id: 'soa-110-scom-codeinfo-health', name: 'codeinfo ',  parent: 'soa-110-scom' } },
      { data: { id: 'soa-110-scom-svninfo-health', name: 'svninfo ',  parent: 'soa-110-scom' } },
      { data: { id: 'soa-110-scom-aeminfo-health', name: 'aeminfo ',  parent: 'soa-110-scom' } },

      { data: { id: 'soa-110-scom2', name: 'scom2', parent: 'soa-110' } },
      { data: { id: 'soa-110-scom2-health', name: 'health',  parent: 'soa-110-scom2' } },
      { data: { id: 'soa-110-scom2-services-health', name: 'services health',  parent: 'soa-110-scom2' } },
      { data: { id: 'soa-110-scom2-codeinfo-health', name: 'codeinfo',  parent: 'soa-110-scom2' } },
      { data: { id: 'soa-110-scom2-svninfo-health', name: 'svninfo',  parent: 'soa-110-scom2' } },
      { data: { id: 'soa-110-scom2-aeminfo-health', name: 'aeminfo',  parent: 'soa-110-scom2' } },

      { data: { id: 'soa-109', name: 'soa-109 (PROD)', } },
      { data: { id: 'soa-109-health', name: 'apache health',  parent: 'soa-109' } },

      { data: { id: 'soa-109-scom', name: 'scom',  parent: 'soa-109' } },
      { data: { id: 'soa-109-scom-health', name: 'health',  parent: 'soa-109-scom' } },
      { data: { id: 'soa-109-scom-services-health', name: 'services health',  parent: 'soa-109-scom' } },
      { data: { id: 'soa-109-scom-codeinfo-health', name: 'codeinfo',  parent: 'soa-109-scom' } },
      { data: { id: 'soa-109-scom-svninfo-health', name: 'svninfo',  parent: 'soa-109-scom' } },
      { data: { id: 'soa-109-scom-aeminfo-health', name: 'aeminfo',  parent: 'soa-109-scom' } },

      { data: { id: 'soa-109-scom2', name: 'scom2', parent: 'soa-109' } },
      { data: { id: 'soa-109-scom2-health', name: 'health',  parent: 'soa-109-scom2' } },
      { data: { id: 'soa-109-scom2-services-health', name: 'services health',  parent: 'soa-109-scom2' } },
      { data: { id: 'soa-109-scom2-codeinfo-health', name: 'codeinfo',  parent: 'soa-109-scom2' } },
      { data: { id: 'soa-109-scom2-svninfo-health', name: 'svninfo',  parent: 'soa-109-scom2' } },
      { data: { id: 'soa-109-scom2-aeminfo-health', name: 'aeminfo',  parent: 'soa-109-scom2' } }
    ]
  },
  layout: {
    name: 'cose',
    padding: 5
  }
});

var scomdashboardService='http://L60001073JRIN:3000';
scomdashboardService = 'http://soa040.subaru1.com:3000';


var scom_nodes = {
	'scomdashboard': 				{url:scomdashboardService+'/originhealth',xmlurl:'', health:'grey',callHealthService:false},
	'originhealth': 				{url:scomdashboardService+'/originhealth',xmlurl:'http://origin-www.subaru.com/health/report.xml',health:'grey',callHealthService:true},
	'soa-110':						{url:'',xmlurl:'',health:'grey',callHealthService:false},
	'soa-110-health':				{url:scomdashboardService+'/soa-110-health',xmlurl:'http://scom-110.prod.subaru.com/server-status',health:'grey',callHealthService:false},
	'soa-110-scom':					{url:'',xmlurl:'',health:'grey',callHealthService:false},
	'soa-110-scom-health':			{url:scomdashboardService+'/soa-110-scom-health',xmlurl:'http://scom-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:true},
	'soa-110-scom-services-health':	{url:'',xmlurl:'http://scom-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-110-scom-codeinfo-health':	{url:'',xmlurl:'http://scom-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-110-scom-svninfo-health':	{url:'',xmlurl:'http://scom-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-110-scom-aeminfo-health':	{url:'',xmlurl:'http://scom-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-110-scom2':				{url:'',xmlurl:'http://scom-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-110-scom2-health':			{url:scomdashboardService+'/soa-110-scom2-health',xmlurl:'http://scom2-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:true},
	'soa-110-scom2-services-health':{url:'',xmlurl:'http://scom2-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-110-scom2-codeinfo-health':{url:'',xmlurl:'http://scom2-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-110-scom2-svninfo-health':{url:'',xmlurl:'http://scom2-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-110-scom2-aeminfo-health': {url:'',xmlurl:'http://scom2-110.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-109':						{url:'',xmlurl:'',health:'grey',callHealthService:false},
	'soa-109-health':				{url:scomdashboardService+'/soa-109-health',xmlurl:'http://scom-109.prod.subaru.com/server-status',health:'grey',callHealthService:false},
	'soa-109-scom':					{url:'',xmlurl:'',health:'grey',callHealthService:false},
	'soa-109-scom-health':			{url:scomdashboardService+'/soa-109-scom-health',xmlurl:'http://scom-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:true},
	'soa-109-scom-services-health': {url:'',xmlurl:'http://scom-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-109-scom-codeinfo-health': {url:'',xmlurl:'http://scom-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-109-scom-svninfo-health': {url:'',xmlurl:'http://scom-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-109-scom-aeminfo-health':  {url:'',xmlurl:'http://scom-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-109-scom2':				{url:'',xmlurl:'',health:'grey',callHealthService:false},
	'soa-109-scom2-health':			{url:scomdashboardService+'/soa-109-scom2-health',xmlurl:'http://scom2-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:true},
	'soa-109-scom2-services-health':{url:'',xmlurl:'http://scom2-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-109-scom2-codeinfo-health':{url:'',xmlurl:'http://scom2-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-109-scom2-svninfo-health':{url:'',xmlurl:'http://scom2-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false},
	'soa-109-scom2-aeminfo-health':{url:'',xmlurl:'http://scom2-109.prod.subaru.com/health/report.xml',health:'grey',callHealthService:false}
	};


//on click
//cy.$('[id^=soa-],#originhealth').on('tap', function(e){
//cy.$('#originhealth,#soa-110-scom-health,#soa-110-scom2-health,#soa-109-scom-health,#soa-109-scom2-health,#soa-110-health,#soa-109-health').on('tap', function(e){
cy.nodes("*").on('tap', function(e){
	var ele = e.cyTarget;
 	if (scom_nodes[ele.id()].xmlurl)
 	{
		logMessage("loading " + scom_nodes[ele.id()].xmlurl)
		scom_nodes[ele.id()].window = window.open(scom_nodes[ele.id()].xmlurl);
		logMessage("loaded " + scom_nodes[ele.id()].xmlurl)
 	}
});

var logMessage = function(message)
{
 	$("#status_message").val(message);
 	console.log(message);
}

var removeTimeFromDateStr = function(dateStr)
{
	//format 2015-03-02T21:26:51.000+0000   chop off last 9
	return dateStr.substring(0,dateStr.length-9).replace("T"," ");
}

var setNode = function(nodeId,healthObj)
{
  logMessage(nodeId+": changed health to " + scom_nodes[nodeId].health)

  if (healthObj)
  {
  		//update where origin is pointing to
		if (nodeId == 'originhealth')
		{
			//healthObj.status.host  'soa-110'
			//healthObj.status.container = 'scom'
			var newLink = healthObj.status.host+'-'+healthObj.status.container;

			cy.remove(cy.$("#origin-link"));
			cy.add([
			  { group: "edges", data: { id: 'origin-link', source: 'originhealth', target: newLink} }
			]);
		}

		if (healthObj && healthObj.status && healthObj.status.health)
		{
			scom_nodes[nodeId].health = healthObj.status.health;

			//update Service Node
			//handle children so i can reuse json and don't need to make another call
			//soa-110-scom2-services-health
			var nodeIdService = healthObj.status.host+"-"+healthObj.status.container+"-services-health";
			scom_nodes[nodeIdService].health = healthObj.status.statusChecks.statusCheck.health;
			setHealthOfNode(nodeIdService);

			//update CodeInfo Node
			//healthObj.status.externals.external[0].$t
			//<code-release>release-ms-12172014-1752</code-release>
			var nodeCodeInfo = healthObj.status.host+"-"+healthObj.status.container+"-codeinfo-health";
			var codeInfoVersion = $.xml2json(healthObj.status.externals.external[0].$t);
			if (codeInfoVersion)
			{
				cy.$('#'+nodeCodeInfo).data("name","codeinfo "+codeInfoVersion);
				scom_nodes[nodeCodeInfo].health = 'green';
			}
			else
			{
				cy.$('#'+nodeCodeInfo).data("name","codeinfo no version info");
				scom_nodes[nodeCodeInfo].health = 'red';
			}
			setHealthOfNode(nodeCodeInfo);

			//update aeminfo
			var aemInfo = $.xml2json(healthObj.status.externals.external[1].$t);
			var nodeAEMInfo = healthObj.status.host+"-"+healthObj.status.container+"-aeminfo-health";
			//<?xml version="1.0" encoding="UTF-8" standalone="yes"?><package-version><name>Publish-Package</name><version>1.0</version><description>A package which can be replicated (activated) onto the publish instance. This package contains all development artifacts, as well as all content that has been authored through either an import or manually.</description><build-number>1375</build-number><build-date>2014-12-23T09:26:02-05:00</build-date><hash>B62A0E5211957FAC3A1E6E61386ABEBE</hash></package-version>
			var aemInfoVersion = $.xml2json(healthObj.status.externals.external[1].$t);
			if (aemInfoVersion)
			{
				//aemInfo.build_number   aemInfo.build_date
				cy.$('#'+nodeAEMInfo).data("name","aeminfo "+aemInfoVersion.build_number+", "+removeTimeFromDateStr(aemInfoVersion.build_date));
				scom_nodes[nodeAEMInfo].health = 'green';
			}
			else
			{
				cy.$('#'+nodeAEMInfo).data("name","aeminfo no version info");
				scom_nodes[nodeAEMInfo].health = 'red';
			}
			setHealthOfNode(nodeAEMInfo);

			//svnInfo
			var nodeIdsvn = healthObj.status.host+"-"+healthObj.status.container+"-svninfo-health";
			scom_nodes[nodeIdsvn].health = healthObj.status.extensions.extension.svnInfo.health;
			setHealthOfNode(nodeIdsvn);
		}
		else
		{
			scom_nodes[nodeId].health = "red";
			var nodeHeader = nodeId.substr(0,nodeId.lastIndexOf("-")-1);
			logMessage("nodeHeader="+nodeHeader);

			scom_nodes[nodeHeader+"-services-health"].health = "red";
			setHealthOfNode(nodeHeader+"-services-health");
			scom_nodes[nodeHeader+"-codeinfo-health"].health = "red";
			setHealthOfNode(nodeHeader+"-codeinfo-health");
			scom_nodes[nodeHeader+"-aeminfo-health"].health = "red";
			setHealthOfNode(nodeHeader+"-aeminfo-health");
			scom_nodes[nodeHeader+"-svninfo-health"].health = "red";
			setHealthOfNode(nodeHeader+"-svninfo-health");
		}

  }
 	setHealthOfNode(nodeId);
}


var setHealthOfNode = function(nodeId)
{
 //@todo should be rewritten, not pretty
  if (scom_nodes[nodeId].health == 'red')
  {
  	cy.style()
	  .selector("#"+nodeId)
		.css({
		  'background-color': 'red'
		}).update();
  }
  else if (scom_nodes[nodeId].health == 'green')
  {
  	cy.style()
	  .selector("#"+nodeId)
		.css({
		  'background-color': 'green'
		}).update();
  }
  else
  {
  	cy.style()
	  .selector("#"+nodeId)
		.css({
		  'background-color': 'grey'
		}).update();
  }
}


cy.nodes().forEach(function( ele ){

    //skip nodes we don't want to make health checks on
	setNode(ele.id(),null);
    if (scom_nodes[ele.id()].callHealthService)
	{
		logMessage(ele.id()+": getting health status...");

		$.ajax({
		  type: 'GET',
		  url: scom_nodes[ele.id()].url,
		  contentType: 'text/plain',
	  	  dataType: 'json',
	  	  timeout: 10000,
		  success: function(data)
		  {
			scom_nodes["scomdashboard"].health = 'green';
			setNode("scomdashboard",null);

			if (data){
				setNode(ele.id(),data);
			//	logMessage(JSON.stringify(data));
			}else {
				logMessage(ele.id()+": unable to parse json response");
			}
		  },
		  error: function (xhr, ajaxOptions, thrownError) {
			 //assume on any error scomdashboard service is down
			 scom_nodes["scomdashboard"].health = 'red';
			 setNode("scomdashboard",null);

			 logMessage(ele.id()+":"+xhr.status);
		  }
		});
	}
});


}); // on dom ready

</script>
<div>Status Message: <input id="status_message" type="text" size="60" disabled><br></div>
</body>
</html>
